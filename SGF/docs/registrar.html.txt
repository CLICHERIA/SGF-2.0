<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registrar — SGF</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="container">
    <header class="header">
      <img src="assets/img/logosovel1337.png" class="logo" alt="logo" />
      <div>
        <div class="title">Registrar Ferramental</div>
        <div class="subtitle">Adicione um novo ferramental ao inventário</div>
      </div>
    </header>

    <main class="card fade-in">
      <form id="formRegistro" class="form-grid" onsubmit="return false;">
        <select id="tipo" class="select" required>
          <option value="">Tipo de Ferramental</option>
          <option>Faca</option>
          <option>Clichê</option>
          <option>Outro</option>
        </select>

        <input id="nfe" class="input" placeholder="Nº da NF-e (opcional)" />
        <input id="sv" class="input" placeholder="SV (código)" required />
        <input id="nome" class="input" placeholder="Nome do Ferramental" required />
        <input id="dataRegistro" class="input" placeholder="Data de Registro (dd/mm/aaaa hh:mm)" />
        <input id="estado" class="input" placeholder="Estado (Em uso / Danificada / Em manutenção / Para substituir)" required />
        <input id="localizacao" class="input" placeholder="Localização (Armário, fileira, posição)" required />

        <div style="display:flex; gap:10px; align-items:center;">
          <button id="btnRegistrar" class="btn" type="button">Registrar</button>
          <button class="btn ghost" type="button" onclick="location.href='menu.html'">Voltar</button>
        </div>
      </form>
    </main>
  </div>

  <script type="module">
    import { auth } from './assets/js/firebase-config.js';
    import { registrarFerramental } from './assets/js/script.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";

    onAuthStateChanged(auth, user => {
      if (!user) {
        Swal.fire({ icon:'warning', title:'Faça login', text:'Você precisa efetuar login antes de registrar.' }).then(()=> window.location.href='index.html');
      }
    });

    document.getElementById('btnRegistrar').onclick = async () => {
      const tipo = document.getElementById('tipo').value;
      const nfe = document.getElementById('nfe').value.trim();
      const sv = document.getElementById('sv').value.trim();
      const nome = document.getElementById('nome').value.trim();
      const dataRegistro = document.getElementById('dataRegistro').value.trim() || new Date().toLocaleString();
      const estado = document.getElementById('estado').value.trim();
      const localizacao = document.getElementById('localizacao').value.trim();

      if(!tipo || !sv || !nome || !estado || !localizacao) {
        Swal.fire({ icon:'error', title:'Campos faltando', text:'Preencha todos os campos obrigatórios.'});
        return;
      }

      const user = auth.currentUser;
      const responsavel = user ? user.email : "anônimo";

      const payload = { tipo, nfe, sv, nome, dataRegistro, estado, localizacao, responsavel };
      const id = await registrarFerramental(payload);
      if(id) setTimeout(()=> location.href='consultar.html', 900);
    };
  </script>
</body>
</html>

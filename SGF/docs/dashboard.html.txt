<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard — SGF</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <header class="header">
      <img src="assets/img/logosovel1337.png" class="logo" alt="logo" />
      <div>
        <div class="title">Dashboard</div>
        <div class="subtitle">Visão geral — métricas em tempo real</div>
      </div>
    </header>

    <div class="dashboard-grid card fade-in">
      <div>
        <div style="display:flex; gap:12px; margin-bottom:12px;">
          <div class="metric" style="flex:1">
            <div>
              <div class="small">Total de Ferramentais</div>
              <div id="totalCount" class="big">0</div>
            </div>
          </div>
          <div class="metric" style="width:240px">
            <div>
              <div class="small">Última atualização</div>
              <div id="lastUpdate" class="big">—</div>
            </div>
          </div>
        </div>

        <div class="card" style="padding:12px;">
          <canvas id="chartTipo" height="180"></canvas>
        </div>

        <div style="margin-top:12px;" class="card">
          <canvas id="chartEstado" height="140"></canvas>
        </div>
      </div>

      <aside class="card">
        <h4 style="margin-top:0; color:var(--accent)">Resumo</h4>
        <div id="listaResumo" style="display:flex;flex-direction:column;gap:8px;"></div>
        <div style="margin-top:12px;">
          <a class="btn" href="consultar.html">Abrir Consulta</a>
          <a class="btn ghost" href="menu.html">Voltar</a>
        </div>
      </aside>
    </div>

    <div class="footer">Dados sincronizados via Firestore</div>
  </div>

  <script type="module">
    import { onFerramentaisChange } from './assets/js/script.js';
    import Chart from 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';

    const totalCountEl = document.getElementById('totalCount');
    const lastUpdateEl = document.getElementById('lastUpdate');
    const listaResumo = document.getElementById('listaResumo');

    const ctxTipo = document.getElementById('chartTipo').getContext('2d');
    const ctxEstado = document.getElementById('chartEstado').getContext('2d');
    let chartTipo = new Chart(ctxTipo, {
      type:'doughnut',
      data:{ labels:[], datasets:[{ data:[], backgroundColor: ['#0099cc','#00b3d6','#66c2d9','#a7e7f7'] }]},
      options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
    });
    let chartEstado = new Chart(ctxEstado, {
      type:'bar',
      data:{ labels:[], datasets:[{ label:'Quantidade', data:[], backgroundColor:'#00b3d6' }]},
      options:{ responsive:true, plugins:{ legend:{ display:false }}, scales:{ x:{ grid:{ display:false }}}}
    });

    function atualizarUI(arr){
      totalCountEl.textContent = arr.length;
      lastUpdateEl.textContent = new Date().toLocaleString();

      const byTipo = {};
      const byEstado = {};
      arr.forEach(i=>{
        byTipo[i.tipo || 'Outro'] = (byTipo[i.tipo || 'Outro']||0)+1;
        byEstado[i.estado || 'Não informado'] = (byEstado[i.estado || 'Não informado']||0)+1;
      });

      chartTipo.data.labels = Object.keys(byTipo);
      chartTipo.data.datasets[0].data = Object.values(byTipo);
      chartTipo.update();

      chartEstado.data.labels = Object.keys(byEstado);
      chartEstado.data.datasets[0].data = Object.values(byEstado);
      chartEstado.update();

      listaResumo.innerHTML = '';
      Object.entries(byTipo).forEach(([k,v])=>{
        const el = document.createElement('div');
        el.style = "display:flex;justify-content:space-between; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,0.02);";
        el.innerHTML = `<div style="color:var(--muted)">${k}</div><div style="color:var(--accent)">${v}</div>`;
        listaResumo.appendChild(el);
      });
    }

    // Observa mudanças em tempo real via Firestore
    onFerramentaisChange((arr)=> atualizarUI(arr || []));
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Consultar — SGF</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <!-- SheetJS para export Excel/CSV -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <header class="header">
      <img src="assets/img/logosovel1337.png" class="logo" alt="logo" />
      <div>
        <div class="title">Consulta de Ferramentais</div>
        <div class="subtitle">Busque por SV, Nome ou NF-e</div>
      </div>
    </header>

    <main class="card fade-in">
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <input id="busca" class="input" placeholder="Digite SV, Nome ou NF-e" />
        <button id="btnBuscar" class="btn">Buscar</button>
        <button id="btnVoltar" class="btn ghost" onclick="location.href='menu.html'">Voltar</button>
        <button id="btnExportCSV" class="btn ghost">Exportar CSV</button>
        <button id="btnExportXLS" class="btn">Exportar XLSX</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>Tipo</th><th>NF-e</th><th>SV</th><th>Nome</th><th>Data</th><th>Estado</th><th>Localização</th><th>Responsável</th><th>Ações</th></tr>
          </thead>
          <tbody id="tabela"></tbody>
        </table>
      </div>
    </main>
  </div>

  <script type="module">
    import { buscarTodos, removerFerramental } from './assets/js/script.js';
    import { exportToCSV, exportToXLSX } from './assets/js/exporter.js';

    const tabela = document.getElementById('tabela');
    const btnBuscar = document.getElementById('btnBuscar');
    const btnExportCSV = document.getElementById('btnExportCSV');
    const btnExportXLS = document.getElementById('btnExportXLS');

    let currentList = [];

    function limparTabela(){ tabela.innerHTML = ''; }

    function montarLinha(item){
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td>${item.tipo || ''}</td>
        <td>${item.nfe || ''}</td>
        <td>${item.sv || ''}</td>
        <td>${item.nome || ''}</td>
        <td>${item.dataRegistro || ''}</td>
        <td>${item.estado || ''}</td>
        <td>${item.localizacao || ''}</td>
        <td>${(item.responsavel||'').split('@')[0] || ''}</td>
        <td class="actions">
          <button class="btn ghost editar">Editar</button>
          <button class="btn btn-danger excluir">Excluir</button>
          <button class="btn qrbtn">QR</button>
        </td>
      `;

      tr.querySelector('.editar').onclick = () => location.href = `editar.html?id=${item.id}`;
      tr.querySelector('.excluir').onclick = async () => {
        const res = await Swal.fire({ icon:'warning', title:'Excluir?', text:'Deseja realmente excluir esse registro?', showCancelButton:true });
        if (res.isConfirmed) {
          const ok = await removerFerramental(item.id);
          if(ok) tr.remove();
        }
      };
      tr.querySelector('.qrbtn').onclick = () => gerarQR(item);

      return tr;
    }

    async function carregarTodos(){
      limparTabela();
      const arr = await buscarTodos();
      currentList = arr;
      if(arr.length === 0) tabela.innerHTML = '<tr><td colspan="9">Nenhum ferramental cadastrado</td></tr>';
      else arr.forEach(i => tabela.appendChild(montarLinha(i)));
    }

    btnBuscar.onclick = async () => {
      const termo = document.getElementById('busca').value.trim().toLowerCase();
      if(!termo) return carregarTodos();
      const filtrados = currentList.filter(it => (it.sv && it.sv.toLowerCase().includes(termo)) || (it.nome && it.nome.toLowerCase().includes(termo)) || (it.nfe && it.nfe.toLowerCase().includes(termo)));
      limparTabela();
      if(filtrados.length === 0) tabela.innerHTML = '<tr><td colspan="9">Nenhum ferramental encontrado</td></tr>';
      else filtrados.forEach(i => tabela.appendChild(montarLinha(i)));
    };

    // QR modal
    function gerarQR(item){
      const url = `${window.location.origin}/SGF/detalhes.html?id=${item.id}`;
      const temp = document.createElement('div');
      new QRCode(temp, { text: url, width:260, height:260 });
      const img = temp.querySelector('img') || temp.querySelector('canvas');
      Swal.fire({
        title: `QR — ${item.nome}`,
        html: `<div style="display:flex;justify-content:center">${img ? `<img src="${img.src}" style="width:220px"/>` : 'QR indisponível'}</div>`,
        showConfirmButton:true
      });
    }

    // Export handlers
    btnExportCSV.onclick = () => {
      if(!currentList.length) return Swal.fire({ icon:'info', title:'Nada para exportar' });
      exportToCSV(currentList, 'ferramentais_export.csv');
    };
    btnExportXLS.onclick = () => {
      if(!currentList.length) return Swal.fire({ icon:'info', title:'Nada para exportar' });
      exportToXLSX(currentList, 'ferramentais_export.xlsx');
    };

    // inicial
    carregarTodos();
  </script>
</body>
</html>

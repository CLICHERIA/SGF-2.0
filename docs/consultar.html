<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Consultar ‚Äî SGF</title>

  <!-- Usa o mesmo CSS corporativo -->
  <link rel="stylesheet" href="assets/css/style.css" />

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>

<!-- ===== HERO / √ÅREA INTERNA ===== -->
<section class="hero" style="
    padding: 60px 20px;
    display:flex;
    justify-content:center;
">
    <div class="caixa" style="
        width:100%;
        max-width:1100px;
        background:#f7f9fc;
        border-radius:18px;
        padding:40px 50px;
        box-shadow:0 4px 15px rgba(0,0,0,0.1);
    ">
        
        <!-- Cabe√ßalho interno -->
        <header class="header" style="
            display:flex; 
            gap:20px; 
            align-items:center; 
            margin-bottom:25px;
        ">
            <img src="assets/img/logosovel1337.png" class="logo" 
                 style="width:95px;" alt="logo" />

            <div>
                <div class="title" style="
                    font-size:2.1rem; 
                    color:#123b7a; 
                    font-weight:700;
                ">
                    Consulta de Ferramentais
                </div>

                <div class="subtitle" style="
                    color:#4e4e4e; 
                    font-size:1rem;
                ">
                    Busque por SV, Nome ou NF-e
                </div>
            </div>
        </header>

        <!-- ===== CONTE√öDO PRINCIPAL ===== -->
        <main class="fade-in" style="width:100%;">

            <!-- Barra de busca -->
            <div style="
                display:flex; 
                gap:10px; 
                align-items:center; 
                flex-wrap:wrap; 
                margin-bottom:25px;
                justify-content:center;
            ">
                <input id="busca" class="input" 
                       placeholder="Digite SV, Nome ou NF-e" 
                       style="max-width:350px; width:100%;" />

                <button id="btnBuscar" class="btn">Buscar</button>
                <button id="btnVoltar" class="btn ghost" onclick="location.href='menu.html'">Voltar</button>
                <button id="btnExportCSV" class="btn ghost">Exportar CSV</button>
                <button id="btnExportXLS" class="btn">Exportar XLSX</button>
            </div>

            <!-- Tabela -->
            <div class="table-wrap" style="
                margin-top:20px;
                overflow-x:auto;
            ">
                <table>
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>NF-e</th>
                        <th>SV</th>
                        <th>Nome</th>
                        <th>Data</th>
                        <th>Estado</th>
                        <th>Localiza√ß√£o</th>
                        <th>Respons√°vel</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="tabela"></tbody>
                </table>
            </div>

        </main>
    </div>
</section>

<!-- ===== RODAP√â ===== -->
<footer>
    <div class="footer-grid">

        <div class="footer-col" style="text-align:center;">
            <img src="assets/img/logosovel1337.png" />
            <p>Grupo Sovel, uma empresa genuinamente amazonense.</p>
        </div>

        <div class="footer-col">
            üìç Rua Dr. Jo√£o de Paulo, 600 ‚Äî Col√¥nia Ant√¥nio Aleixo<br>
            Manaus - AM<br><br>

            üìû (92) 9 8202-0067<br><br>

            üïí Seg‚ÄìQui: 7h √†s 17h<br>
            üïí Sexta: 7h √†s 16h
        </div>

        <div class="footer-col">
            <iframe src="https://www.openstreetmap.org/export/embed.html?bbox=-59.97%2C-3.15%2C-59.95%2C-3.12&amp;layer=mapnik&amp;marker=-3.13%2C-59.96"></iframe>
        </div>

    </div>

    <div class="footer-bottom">
        ¬© 2025 Sovel da Amaz√¥nia ‚Äî Todos os direitos reservados.
    </div>
</footer>

<!-- ===== SCRIPTS ===== -->
<script type="module">
    import { buscarTodos, removerFerramental } from './assets/js/script.js';
    import { exportToCSV, exportToXLSX } from './assets/js/exporter.js';

    const tabela = document.getElementById('tabela');
    const btnBuscar = document.getElementById('btnBuscar');
    const btnExportCSV = document.getElementById('btnExportCSV');
    const btnExportXLS = document.getElementById('btnExportXLS');

    let currentList = [];

    function limparTabela(){ tabela.innerHTML = ''; }

    function montarLinha(item){
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td>${item.tipo || ''}</td>
        <td>${item.nfe || ''}</td>
        <td>${item.sv || ''}</td>
        <td>${item.nome || ''}</td>
        <td>${item.dataRegistro || ''}</td>
        <td>${item.estado || ''}</td>
        <td>${item.localizacao || ''}</td>
        <td>${(item.responsavel||'').split('@')[0] || ''}</td>
        <td class="actions">
          <button class="btn ghost editar">Editar</button>
          <button class="btn btn-danger excluir">Excluir</button>
          <button class="btn qrbtn">QR</button>
        </td>
      `;

      tr.querySelector('.editar').onclick = () => location.href = `editar.html?id=${item.id}`;
      tr.querySelector('.excluir').onclick = async () => {
        const res = await Swal.fire({ 
            icon:'warning', 
            title:'Excluir?', 
            text:'Deseja realmente excluir esse registro?', 
            showCancelButton:true 
        });
        if (res.isConfirmed) {
          const ok = await removerFerramental(item.id);
          if(ok) tr.remove();
        }
      };
      tr.querySelector('.qrbtn').onclick = () => gerarQR(item);

      return tr;
    }

    async function carregarTodos(){
      limparTabela();
      const arr = await buscarTodos();
      currentList = arr;

      if(arr.length === 0)
         tabela.innerHTML = '<tr><td colspan="9">Nenhum ferramental cadastrado</td></tr>';
      else
         arr.forEach(i => tabela.appendChild(montarLinha(i)));
    }

    btnBuscar.onclick = async () => {
      const termo = document.getElementById('busca').value.trim().toLowerCase();
      if(!termo) return carregarTodos();

      const filtrados = currentList.filter(it => 
          (it.sv && it.sv.toLowerCase().includes(termo)) ||
          (it.nome && it.nome.toLowerCase().includes(termo)) ||
          (it.nfe && it.nfe.toLowerCase().includes(termo))
      );

      limparTabela();
      if(filtrados.length === 0) 
          tabela.innerHTML = '<tr><td colspan="9">Nenhum ferramental encontrado</td></tr>';
      else 
          filtrados.forEach(i => tabela.appendChild(montarLinha(i)));
    };

    function gerarQR(item){
      const url = `${window.location.origin}/SGF/detalhes.html?id=${item.id}`;
      const temp = document.createElement('div');
      new QRCode(temp, { text: url, width:260, height:260 });
      const img = temp.querySelector('img') || temp.querySelector('canvas');

      Swal.fire({
        title: `QR ‚Äî ${item.nome}`,
        html: `<div style="display:flex; justify-content:center;">${img ? `<img src="${img.src}" style="width:220px"/>` : 'QR indispon√≠vel'}</div>` ,
        showConfirmButton:true
      });
    }

    btnExportCSV.onclick = () => {
      if(!currentList.length) return Swal.fire({ icon:'info', title:'Nada para exportar' });
      exportToCSV(currentList, 'ferramentais_export.csv');
    };

    btnExportXLS.onclick = () => {
      if(!currentList.length) return Swal.fire({ icon:'info', title:'Nada para exportar' });
      exportToXLSX(currentList, 'ferramentais_export.xlsx');
    };

    carregarTodos();
</script>

</body>
</html>
